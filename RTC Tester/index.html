<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Robot WebRTC Video Test</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="controls">
            <button id="connectBtn" onclick="startConnection()">üîå –ü—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—è –¥–æ —Ä–æ–±–æ—Ç–∞</button>
            <button id="disconnectBtn" onclick="stopConnection()" disabled>üîå –í—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—è</button>
            <button id="requestVideoBtn" onclick="requestVideo()" disabled>üìπ –ó–∞–ø—Ä–æ—Å–∏—Ç–∏ –≤—ñ–¥–µ–æ</button>
            <button id="stopVideoBtn" onclick="stopVideo()" disabled>‚èπÔ∏è –ó—É–ø–∏–Ω–∏—Ç–∏ –≤—ñ–¥–µ–æ</button>
            <button id="turnToggleBtn" onclick="toggleTurnMode()" title="–ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è –ø—Ä–∏–º—É—Å–æ–≤–æ–≥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è TURN —Å–µ—Ä–≤–µ—Ä—ñ–≤">üîÑ TURN –í–ö–õ</button>
            <button id="gamepadConnectBtn" onclick="connectGamepad()">üéÆ –ü—ñ–¥–∫–ª—é—á–∏—Ç–∏ –≥–µ–π–º–ø–∞–¥</button>
        </div>
        
        <div class="stats">
            <div class="stat-item">
                <div class="stat-value" id="connectionStatus">‚ùå</div>
                <div class="stat-label">WebSocket –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="robotStatus">‚ùå</div>
                <div class="stat-label">–°—Ç–∞—Ç—É—Å —Ä–æ–±–æ—Ç–∞</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="iceStatus">‚ùå</div>
                <div class="stat-label">TURN/ICE —Å—Ç–∞—Ç—É—Å</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="videoStatus">‚ùå</div>
                <div class="stat-label">–í—ñ–¥–µ–æ–ø–æ—Ç—ñ–∫</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="turnStatus">‚ùå</div>
                <div class="stat-label">TURN —Å–µ—Ä–≤–µ—Ä</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="pixhawkStatus">‚ùå</div>
                <div class="stat-label">Pixhawk</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="gamepadStatus">‚ùå</div>
                <div class="stat-label" id="gamepadLabel"></div>
            </div>
        </div>
        
        <div class="video-container">
            <video id="videoElement" autoplay muted playsinline>
                <p>–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î –≤—ñ–¥–µ–æ –µ–ª–µ–º–µ–Ω—Ç.</p>
            </video>
        </div>
        <div style="width:100%; display:flex; justify-content:center; margin-bottom: 10px;">
            <button id="fullscreenBtn" onclick="toggleFullscreen()">üñµ –ù–∞ –≤–µ—Å—å –µ–∫—Ä–∞–Ω</button>
        </div>
        
        <div id="framesBar"><span id="framesCount">0</span> –æ—Ç—Ä–∏–º–∞–Ω–æ –∫–∞–¥—Ä—ñ–≤</div>
        <div class="status" id="statusLog">
            <div class="status-info">üìã –ñ—É—Ä–Ω–∞–ª –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è:</div>
        </div>
    </div>

    <script>
        let ws = null;
        let pc = null;
        let localVideo = null;
        let statsInterval = null;
        let frameCount = 0;
        let registrationTimeout = null;

        const statusLog = document.getElementById('statusLog');
        const videoElement = document.getElementById('videoElement');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const requestVideoBtn = document.getElementById('requestVideoBtn');
        const stopVideoBtn = document.getElementById('stopVideoBtn');
        const turnToggleBtn = document.getElementById('turnToggleBtn');
        const gamepadConnectBtn = document.getElementById('gamepadConnectBtn');
        
        // TURN —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        let turnModeEnabled = false;

        // –õ–æ–≥–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', () => {
            log('üîÑ TURN —Ä–µ–∂–∏–º –≤–∏–º–∫–Ω–µ–Ω–æ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º - –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –≤–∏–±—ñ—Ä', 'info');
            updateTurnButtonAppearance();
        });

        // WebRTC configuration - –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞
        let rtcConfig = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };

        // –ó–∞–≥—Ä—É–∑–∫–∞ ICE –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞ (–≤–∫–ª—é—á–∞—è TURN —Å–µ—Ä–≤–µ—Ä—ã)
        async function loadICEConfiguration() {
            try {
                log('üßä –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è ICE –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó –∑ —Å–µ—Ä–≤–µ—Ä–∞...');
                
                // –ü–æ–ø—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ URL
                const urls = [
                    'http://localhost:8080/api/ice/config',
                    'http://193.169.240.11:8080/api/ice/config',
                    window.location.origin + '/api/ice/config'
                ];
                
                let iceConfig = null;
                let lastError = null;
                
                for (const url of urls) {
                    try {
                        log(`üîó –°–ø—Ä–æ–±—É—î–º–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑: ${url}`);
                        const response = await fetch(url, {
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json',
                                'Content-Type': 'application/json'
                            },
                            timeout: 5000
                        });
                        
                        if (response.ok) {
                            iceConfig = await response.json();
                            log(`‚úÖ ICE –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞ –∑: ${url}`);
                            break;
                        } else {
                            lastError = `HTTP ${response.status}: ${response.statusText}`;
                            log(`‚ö†Ô∏è ${url}: ${lastError}`);
                        }
                    } catch (error) {
                        lastError = error.message;
                        log(`‚ö†Ô∏è ${url}: ${lastError}`);
                        continue;
                    }
                }
                
                // –Ø–∫—â–æ –Ω–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ fallback –∑ TURN
                if (!iceConfig) {
                    log('‚ö†Ô∏è –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ ICE –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é –∑ —Å–µ—Ä–≤–µ—Ä–∞, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ fallback');
                    iceConfig = {
                        iceServers: [
                            // STUN —Å–µ—Ä–≤–µ—Ä—ã
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:stun1.l.google.com:19302' },
                            { urls: 'stun:stun.cloudflare.com:3478' },
                            
                            // TURN —Å–µ—Ä–≤–µ—Ä (–Ω–æ–≤—ñ –ø–æ—Ä—Ç–∏)
                            {
                                urls: 'turn:193.169.240.11:13478',
                                username: 'robotclient',
                                credential: 'robotclient2024'
                            },
                            {
                                urls: 'turn:193.169.240.11:13478?transport=tcp',
                                username: 'robotclient',
                                credential: 'robotclient2024'
                            }
                        ],
                        iceCandidatePoolSize: 10
                    };
                    log('‚úÖ Fallback –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –∑ TURN —Å–µ—Ä–≤–µ—Ä–æ–º –≥–æ—Ç–æ–≤–∞');
                }
                
                rtcConfig = iceConfig;
                
                // –õ–æ–≥—É—î–º–æ –∑–Ω–∞–π–¥–µ–Ω—ñ —Å–µ—Ä–≤–µ—Ä–∏
                let stunCount = 0;
                let turnCount = 0;
                
                iceConfig.iceServers?.forEach(server => {
                    if (server.urls?.startsWith('turn:') || server.urls?.startsWith('turns:')) {
                        turnCount++;
                        log(`üîÑ TURN —Å–µ—Ä–≤–µ—Ä: ${server.urls} (–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á: ${server.username})`);
                    } else if (server.urls?.startsWith('stun:')) {
                        stunCount++;
                        log(`üßä STUN —Å–µ—Ä–≤–µ—Ä: ${server.urls}`);
                    }
                });
                
                log(`‚úÖ ICE –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞: ${stunCount} STUN + ${turnCount} TURN —Å–µ—Ä–≤–µ—Ä—ñ–≤`, 'connected');
                
                if (turnCount > 0) {
                    updateStatus('iceStatus', 'üîÑ TURN –≥–æ—Ç–æ–≤–∏–π', true);
                } else {
                    updateStatus('iceStatus', 'üßä STUN —Ç—ñ–ª—å–∫–∏', false);
                }
                
                return true;
                
            } catch (error) {
                log(`‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è ICE –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó: ${error.message}`, 'error');
                return false;
            }
        }

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = `status-${type}`;
            const logEntry = `<div class="${className}">[${timestamp}] ${message}</div>`;
            statusLog.innerHTML += logEntry;
            statusLog.scrollTop = statusLog.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function updateStatus(element, value, isConnected = false) {
            const statusElement = document.getElementById(element);
            statusElement.textContent = value;
            statusElement.parentElement.style.borderLeftColor = isConnected ? '#4CAF50' : '#f44336';
        }

        async function startConnection() {
            try {
                log('üöÄ –ü–æ—á–∏–Ω–∞—î–º–æ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ —Ä–æ–±–æ—Ç–∞...');
                connectBtn.disabled = true;
                
                // –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ ICE –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é –ü–ï–†–®–ò–ú –î–ï–õ–û–ú!
                log('üîß –ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç: –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è ICE –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó...');
                const iceLoaded = await loadICEConfiguration();
                
                if (!iceLoaded) {
                    log('‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ ICE –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ fallback', 'error');
                    // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –º—ñ–Ω—ñ–º–∞–ª—å–Ω—É TURN –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é
                    rtcConfig = {
                        iceServers: [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:stun.cloudflare.com:3478' },
                            {
                                urls: 'turn:193.169.240.11:13478',
                                username: 'robotclient',
                                credential: 'robotclient2024'
                            }
                        ],
                        iceCandidatePoolSize: 10
                    };
                    log('‚úÖ Fallback ICE –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∑ TURN —Å–µ—Ä–≤–µ—Ä–æ–º');
                }
                
                // –§—ñ–Ω–∞–ª—å–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ ICE –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó –ø–µ—Ä–µ–¥ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è–º –∑'—î–¥–Ω–∞–Ω–Ω—è
                const turnCount = rtcConfig.iceServers?.filter(s => s.urls?.startsWith('turn')).length || 0;
                log(`‚úÖ ICE –≥–æ—Ç–æ–≤–∏–π: ${rtcConfig.iceServers?.length || 0} —Å–µ—Ä–≤–µ—Ä—ñ–≤ (TURN: ${turnCount})`);
                
                // TURN —Ä–µ–∂–∏–º –≤–∫–ª—é—á–µ–Ω–æ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
                if (turnModeEnabled && turnCount > 0) {
                    log('üîÑ TURN —Ä–µ–∂–∏–º –ê–ö–¢–ò–í–ï–ù –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º: –ø—Ä–∏–º—É—Å–æ–≤–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è TURN relay');
                    rtcConfig.iceTransportPolicy = 'relay'; // –ü—Ä–∏–º—É—Å–æ–≤–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ TURN
                    log('üîÑ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —Ä–µ–∂–∏–º relay-only –¥–ª—è –ø—Ä–∏–º—É—Å–æ–≤–æ–≥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è TURN');
                } else if (turnCount > 0) {
                    log('üîÑ TURN —Å–µ—Ä–≤–µ—Ä–∏ –¥–æ—Å—Ç—É–ø–Ω—ñ, –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –≤–∏–±—ñ—Ä');
                    // –í–∏–¥–∞–ª—è—î–º–æ iceTransportPolicy –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –≤–∏–±–æ—Ä—É
                    delete rtcConfig.iceTransportPolicy;
                }
                
                // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è WebSocket –∑'—î–¥–Ω–∞–Ω–Ω—è
                const wsUrl = `ws://193.169.240.11:80`;
                ws = new WebSocket(wsUrl);
                
                ws.onopen = () => {
                    log('‚úÖ WebSocket –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ', 'connected');
                    updateStatus('connectionStatus', 'üîó WebSocket', true);
                    
                    // –†–µ—î—Å—Ç—Ä—É—î–º–æ—Å—è —è–∫ –∫–ª—ñ—î–Ω—Ç –∫–µ—Ä—É–≤–∞–Ω–Ω—è
                    log('üìù –†–µ—î—Å—Ç—Ä—É—î–º–æ—Å—è —è–∫ –∫–ª—ñ—î–Ω—Ç –∫–µ—Ä—É–≤–∞–Ω–Ω—è...');
                    ws.send('REGISTER!CONTROLLER');
                    
                    // –£—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ —Ç–∞–π–º–∞—É—Ç —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó
                    registrationTimeout = setTimeout(() => {
                        if (ws && ws.readyState === WebSocket.OPEN) {
                            log('‚ùå –¢–∞–π–º–∞—É—Ç —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó - —Å–µ—Ä–≤–µ—Ä –Ω–µ –≤—ñ–¥–ø–æ–≤—ñ–≤', 'error');
                            updateStatus('connectionStatus', '‚ùå –¢–∞–π–º–∞—É—Ç —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó');
                        }
                    }, 5000);
                };
                
                ws.onmessage = async (event) => {
                    const message = event.data;
                    log(`üì• –û—Ç—Ä–∏–º–∞–Ω–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è: ${message}`);
                    
                    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —Ü–µ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –Ω–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é –∞–±–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ –ø—Ä–µ—Ñ—ñ–∫—Å–æ–º
                    if (message === 'REGISTERED!CONTROLLER') {
                        // –°–∫–∞—Å–æ–≤—É—î–º–æ —Ç–∞–π–º–∞—É—Ç —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó
                        if (registrationTimeout) {
                            clearTimeout(registrationTimeout);
                            registrationTimeout = null;
                        }
                        
                        log('‚úÖ –£—Å–ø—ñ—à–Ω–æ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω—ñ —è–∫ –∫–µ—Ä—É—é—á–∏–π', 'connected');
                        updateStatus('connectionStatus', 'üéÆ –ö–µ—Ä—É—é—á–∏–π', true);
                        
                        // –ü–æ–∫–∞–∑—É—î–º–æ –ø–∞–Ω–µ–ª—å –∫–µ—Ä—É–≤–∞–Ω–Ω—è —Ç–∞ –∫–Ω–æ–ø–∫–∏ –≤—ñ–¥–µ–æ
                        // robotControls.style.display = 'block'; // –í–∏–¥–∞–ª–µ–Ω–æ
                        requestVideoBtn.disabled = false;
                        
                        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–∞–ø–∏—Ç—É—î–º–æ –≤—ñ–¥–µ–æ —á–µ—Ä–µ–∑ –Ω–µ–≤–µ–ª–∏–∫—É –∑–∞—Ç—Ä–∏–º–∫—É
                        setTimeout(() => {
                            if (ws && ws.readyState === WebSocket.OPEN) {
                                requestVideo();
                            }
                        }, 1000);
                    } else if (message.startsWith('TELEMETRY!')) {
                        // –¢–µ–ª–µ–º–µ—Ç—Ä—ñ—è –≤—ñ–¥ —Ä–æ–±–æ—Ç–∞
                        try {
                            const jsonData = message.substring(10); // –í–∏–¥–∞–ª—è—î–º–æ "TELEMETRY!"
                            const data = JSON.parse(jsonData);
                            handleTelemetry(data);
                            log(`üìä –¢–µ–ª–µ–º–µ—Ç—Ä—ñ—è: ${data.type}`, 'info');
                        } catch (e) {
                            log(`‚ùå –ü–æ–º–∏–ª–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥—É —Ç–µ–ª–µ–º–µ—Ç—Ä—ñ—ó: ${e.message}`, 'error');
                        }
                    } else if (message.startsWith('{')) {
                        // JSON –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è (WebRTC —Å–∏–≥–Ω–∞–ª—ñ–Ω–≥)
                        try {
                            const data = JSON.parse(message);
                            await handleWebSocketMessage(data);
                        } catch (e) {
                            log(`‚ùå –ü–æ–º–∏–ª–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥—É JSON: ${e.message}`, 'error');
                        }
                    } else {
                        // –Ü–Ω—à—ñ —Ç–µ–∫—Å—Ç–æ–≤—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
                        log(`üìÑ –¢–µ–∫—Å—Ç–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è: ${message}`);
                    }
                };
                
                ws.onerror = (error) => {
                    log(`‚ùå –ü–æ–º–∏–ª–∫–∞ WebSocket: ${error}`, 'error');
                    updateStatus('connectionStatus', '‚ùå –ü–æ–º–∏–ª–∫–∞');
                };
                
                ws.onclose = () => {
                    log('üîå WebSocket –≤—ñ–¥–∫–ª—é—á–µ–Ω–æ');
                    updateStatus('connectionStatus', '‚ùå –í—ñ–¥–∫–ª—é—á–µ–Ω–æ');
                    connectBtn.disabled = false;
                    disconnectBtn.disabled = true;
                };
                
            } catch (error) {
                log(`‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è: ${error.message}`, 'error');
                connectBtn.disabled = false;
            }
        }

        let currentSessionId = null;

        async function initWebRTC(sessionId) {
            try {
                log('üé¨ –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è WebRTC...');
                currentSessionId = sessionId;
                
                // –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ü–µ—Ä–µ–∫–æ–Ω—É—î–º–æ—Å—å, —â–æ ICE –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞!
                if (!rtcConfig || !rtcConfig.iceServers || rtcConfig.iceServers.length < 5) {
                    log('‚ö†Ô∏è ICE –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞ –∞–±–æ –Ω–µ–ø–æ–≤–Ω–∞, –ø—Ä–∏–º—É—Å–æ–≤–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...');
                    await loadICEConfiguration();
                }
                
                // –õ–æ–≥—É—î–º–æ —Ñ—ñ–Ω–∞–ª—å–Ω—É ICE –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é –ø–µ—Ä–µ–¥ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è–º RTCPeerConnection
                log(`üßä –°—Ç–≤–æ—Ä–µ–Ω–Ω—è RTCPeerConnection –∑ ${rtcConfig.iceServers?.length || 0} ICE —Å–µ—Ä–≤–µ—Ä–∞–º–∏:`);
                rtcConfig.iceServers?.forEach((server, index) => {
                    if (server.urls?.startsWith('turn:') || server.urls?.startsWith('turns:')) {
                        log(`   ${index + 1}. TURN: ${server.urls} (user: ${server.username})`);
                    } else {
                        log(`   ${index + 1}. STUN: ${server.urls}`);
                    }
                });
                
                // –î–Ü–ê–ì–ù–û–°–¢–ò–ö–ê: –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ ICE –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é –≤ –º–æ–º–µ–Ω—Ç —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è
                log('üî¨ –î–Ü–ê–ì–ù–û–°–¢–ò–ö–ê RTCPeerConnection:');
                log(`   RTCPeerConnection.constructor –æ—Ç—Ä–∏–º—É—î: ${JSON.stringify(rtcConfig, null, 2)}`);
                
                // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è peer connection
                pc = new RTCPeerConnection(rtcConfig);
                
                // –ù–µ–≥–∞–π–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —â–æ –±—Ä–∞—É–∑–µ—Ä –æ—Ç—Ä–∏–º–∞–≤
                const actualConfig = pc.getConfiguration();
                log('üî¨ –§–∞–∫—Ç–∏—á–Ω–∞ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è RTCPeerConnection:');
                log(`   –ë—Ä–∞—É–∑–µ—Ä –∑–±–µ—Ä—ñ–≥: ${JSON.stringify(actualConfig, null, 2)}`);
                
                // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —â–æ TURN —Å–µ—Ä–≤–µ—Ä–∏ –¥—ñ–π—Å–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ –∑ credentials
                const turnServers = actualConfig.iceServers?.filter(s => {
                    const urls = Array.isArray(s.urls) ? s.urls : [s.urls];
                    return urls.some(url => url.startsWith('turn:') || url.startsWith('turns:'));
                }) || [];
                log(`üî¨ TURN —Å–µ—Ä–≤–µ—Ä—ñ–≤ —É –±—Ä–∞—É–∑–µ—Ä—ñ: ${turnServers.length}`);
                turnServers.forEach((server, i) => {
                    const urls = Array.isArray(server.urls) ? server.urls : [server.urls];
                    urls.forEach((url, j) => {
                        if (url.startsWith('turn:') || url.startsWith('turns:')) {
                            log(`   TURN ${i+1}.${j+1}: ${url} | user: "${server.username}" | pass: "${server.credential ? '[–°–ö–†–ò–¢–û]' : '–í–Ü–î–°–£–¢–ù–ï'}"`);
                        }
                    });
                });
                
                // –û–±—Ä–æ–±–∫–∞ ICE candidates
                pc.onicecandidate = (event) => {
                    if (event.candidate && currentSessionId) {
                        log('üßä –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ ICE candidate');
                        ws.send(JSON.stringify({
                            type: 'webrtc-signal',
                            signalType: 'ice-candidate',
                            sessionId: currentSessionId,
                            data: {
                                candidate: event.candidate.candidate,
                                sdpMLineIndex: event.candidate.sdpMLineIndex,
                                sdpMid: event.candidate.sdpMid
                            }
                        }));
                    }
                };
                
                // –û–±—Ä–æ–±–∫–∞ –∑–º—ñ–Ω —Å—Ç–∞–Ω—É –∑'—î–¥–Ω–∞–Ω–Ω—è
                pc.onconnectionstatechange = () => {
                    log(`üîó –°—Ç–∞–Ω –∑'—î–¥–Ω–∞–Ω–Ω—è: ${pc.connectionState}`);
                    updateStatus('connectionStatus', `üîó ${pc.connectionState}`, 
                        pc.connectionState === 'connected');
                    
                    // –î–ï–¢–ê–õ–¨–ù–ê –î–Ü–ê–ì–ù–û–°–¢–ò–ö–ê –ø—Ä–∏ –∑–º—ñ–Ω—ñ —Å—Ç–∞–Ω—É
                    if (pc.connectionState === 'connected' || pc.connectionState === 'failed') {
                        setTimeout(() => analyzeConnectionDetails(), 1000);
                    }
                };
                
                pc.oniceconnectionstatechange = () => {
                    log(`üßä –°—Ç–∞–Ω ICE: ${pc.iceConnectionState}`);
                    updateStatus('iceStatus', `üßä ${pc.iceConnectionState}`, 
                        pc.iceConnectionState === 'connected');
                    
                    // –ê–ù–ê–õ–Ü–ó –ü–†–ò –ö–û–ñ–ù–û–ú–£ –ó–ú–Ü–ù–Ü ICE STATE
                    if (pc.iceConnectionState === 'connected' || pc.iceConnectionState === 'completed' || pc.iceConnectionState === 'failed') {
                        setTimeout(() => analyzeICECandidatePairs(), 500);
                    }
                };

                // –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ TURN –∑'—î–¥–Ω–∞–Ω–Ω—è
                pc.onicegatheringstatechange = () => {
                    log(`üîÑ ICE –∑–±—ñ—Ä: ${pc.iceGatheringState}`);
                    if (pc.iceGatheringState === 'complete') {
                        checkTurnUsage();
                    }
                };
                
                // –û–±—Ä–æ–±–∫–∞ –≤—Ö—ñ–¥–Ω–æ–≥–æ –≤—ñ–¥–µ–æ–ø–æ—Ç–æ–∫—É
                pc.ontrack = (event) => {
                    log('üé• –û—Ç—Ä–∏–º–∞–Ω–æ –≤—ñ–¥–µ–æ–ø–æ—Ç—ñ–∫!', 'connected');
                    updateStatus('videoStatus', 'üé• –ê–∫—Ç–∏–≤–Ω–∏–π', true);
                    
                    if (event.streams && event.streams[0]) {
                        videoElement.srcObject = event.streams[0];
                        startVideoStats();
                        startTurnMonitoring(); // –ó–∞–ø—É—Å–∫–∞—î–º–æ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ TURN –ø—ñ—Å–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –≤—ñ–¥–µ–æ
                    }
                };
                
                disconnectBtn.disabled = false;
                requestVideoBtn.disabled = true;
                stopVideoBtn.disabled = false;
                
                log(`‚úÖ WebRTC —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ –¥–ª—è —Å–µ—Å—ñ—ó: ${sessionId}`);
                
            } catch (error) {
                log(`‚ùå –ü–æ–º–∏–ª–∫–∞ WebRTC: ${error.message}`, 'error');
            }
        }

        function handleTelemetry(data) {
            // –û–±—Ä–æ–±–∫–∞ —Ç–µ–ª–µ–º–µ—Ç—Ä—ñ—ó –≤—ñ–¥ —Ä–æ–±–æ—Ç–∞
            if (data.type === 'robot_status') {
                updateStatus('robotStatus', 'ü§ñ –û–Ω–ª–∞–π–Ω', true);
                
                // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç—É—Å Pixhawk, —è–∫—â–æ —î –¥–∞–Ω—ñ
                if (data.pixhawk !== undefined) {
                    updateStatus('pixhawkStatus', data.pixhawk ? '‚úàÔ∏è –ü—ñ–¥–∫–ª—é—á–µ–Ω–∏–π' : '‚ùå –í—ñ–¥–∫–ª—é—á–µ–Ω–∏–π', data.pixhawk);
                }
                
                // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç—É—Å –≤—ñ–¥–µ–æ, —è–∫—â–æ —î –¥–∞–Ω—ñ
                if (data.video_status !== undefined) {
                    updateStatus('videoStatus', data.video_status ? 'üé• –¢—Ä–∞–Ω—Å–ª—é—î—Ç—å—Å—è' : 'üì∑ –û—á—ñ–∫—É–≤–∞–Ω–Ω—è', data.video_status);
                }
            } else if (data.type === 'video_status') {
                const isActive = data.status === 'streaming' || data.status === 'active';
                updateStatus('videoStatus', isActive ? 'üé• –¢—Ä–∞–Ω—Å–ª—é—î—Ç—å—Å—è' : 'üì∑ –ì–æ—Ç–æ–≤–∏–π', isActive);
            } else if (data.type === 'robot_dual_thread_status') {
                updateStatus('robotStatus', data.robotStatus.webSocket.connected ? 'ü§ñ –û–Ω–ª–∞–π–Ω' : '‚ùå –ù–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–∏–π', true);
                updateStatus('pixhawkStatus', data.robotStatus.controlThread.pixhawk.connected ? '‚úàÔ∏è –ü—ñ–¥–∫–ª—é—á–µ–Ω–∏–π' : '‚ùå –í—ñ–¥–∫–ª—é—á–µ–Ω–∏–π', data.robotStatus.controlThread.pixhawk.connected);
                updateStatus('videoStatus', data.robotStatus.videoThread.isStreaming ? 'üé• –¢—Ä–∞–Ω—Å–ª—é—î—Ç—å—Å—è' : 'ÔøΩÔøΩ –û—á—ñ–∫—É–≤–∞–Ω–Ω—è', data.robotStatus.videoThread.isStreaming);
            }
        }

        async function handleWebSocketMessage(data) {
            if (data.type !== 'webrtc-signal') return;
            
            try {
                switch (data.signalType) {
                    case 'offer':
                        log(`üì• –û—Ç—Ä–∏–º–∞–Ω–æ offer –≤—ñ–¥ —Ä–æ–±–æ—Ç–∞ –¥–ª—è —Å–µ—Å—ñ—ó: ${data.sessionId}`);
                        
                        if (!pc) {
                            log('‚ùå WebRTC –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è offer', 'error');
                            return;
                        }
                        
                        // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ sessionId, —è–∫—â–æ –≤—ñ–Ω –ø—Ä–∏–π—à–æ–≤ –∑ offer
                        if (data.sessionId && !currentSessionId) {
                            currentSessionId = data.sessionId;
                        }
                        
                        await pc.setRemoteDescription(new RTCSessionDescription({
                            type: 'offer',
                            sdp: data.data.sdp
                        }));
                        
                        const answer = await pc.createAnswer();
                        await pc.setLocalDescription(answer);
                        
                        log('üì§ –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ answer');
                        ws.send(JSON.stringify({
                            type: 'webrtc-signal',
                            signalType: 'answer',
                            sessionId: currentSessionId || data.sessionId,
                            data: {
                                type: 'answer',
                                sdp: answer.sdp
                            }
                        }));
                        break;
                        
                    case 'ice-candidate':
                        log(`üì• –û—Ç—Ä–∏–º–∞–Ω–æ ICE candidate –≤—ñ–¥ —Ä–æ–±–æ—Ç–∞ –¥–ª—è —Å–µ—Å—ñ—ó: ${data.sessionId}`);
                        
                        if (!pc) {
                            log('‚ùå WebRTC –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ –¥–ª—è ICE candidate', 'error');
                            return;
                        }
                        
                        await pc.addIceCandidate(new RTCIceCandidate({
                            candidate: data.data.candidate,
                            sdpMLineIndex: data.data.sdpMLineIndex,
                            sdpMid: data.data.sdpMid
                        }));
                        break;
                        
                    case 'error':
                        log(`‚ùå –ü–æ–º–∏–ª–∫–∞ WebRTC –≤—ñ–¥ —Ä–æ–±–æ—Ç–∞: ${data.data.error}`, 'error');
                        updateStatus('videoStatus', '‚ùå –ü–æ–º–∏–ª–∫–∞');
                        break;
                        
                    case 'session-end':
                        log(`üîö –°–µ—Å—ñ—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —Ä–æ–±–æ—Ç–æ–º: ${data.sessionId}`, 'info');
                        updateStatus('videoStatus', '‚ùå –°–µ—Å—ñ—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
                        if (pc) {
                            pc.close();
                            pc = null;
                        }
                        currentSessionId = null;
                        break;
                        
                    default:
                        log(`ü§∑ –ù–µ–≤—ñ–¥–æ–º–∏–π —Ç–∏–ø —Å–∏–≥–Ω–∞–ª—É: ${data.signalType}`);
                }
            } catch (error) {
                log(`‚ùå –ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ —Å–∏–≥–Ω–∞–ª—É: ${error.message}`, 'error');
            }
        }

        function startVideoStats() {
            if (statsInterval) clearInterval(statsInterval);
            
            statsInterval = setInterval(() => {
                if (pc && pc.connectionState === 'connected') {
                    pc.getStats().then(stats => {
                        stats.forEach(report => {
                            if (report.type === 'inbound-rtp' && report.mediaType === 'video') {
                                if (report.framesReceived !== undefined) {
                                    frameCount = report.framesReceived;
                                    updateStatus('framesCount', frameCount.toString(), frameCount > 0);
                                }
                            }
                        });
                    });
                }
            }, 1000);
        }

        function stopConnection() {
            log('üõë –í—ñ–¥–∫–ª—é—á–∞—î–º–æ—Å—å...');
            
            if (statsInterval) {
                clearInterval(statsInterval);
                statsInterval = null;
            }
            
            if (registrationTimeout) {
                clearTimeout(registrationTimeout);
                registrationTimeout = null;
            }
            
            if (pc) {
                pc.close();
                pc = null;
            }
            
            if (ws) {
                ws.close();
                ws = null;
            }
            
            currentSessionId = null;
            videoElement.srcObject = null;
            frameCount = 0;
            
            updateStatus('connectionStatus', '‚ùå –í—ñ–¥–∫–ª—é—á–µ–Ω–æ');
            updateStatus('robotStatus', '‚ùå –ù–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–∏–π');
            updateStatus('iceStatus', '‚ùå –í—ñ–¥–∫–ª—é—á–µ–Ω–æ');
            updateStatus('videoStatus', '‚ùå –í—ñ–¥–∫–ª—é—á–µ–Ω–æ');
            updateStatus('framesCount', '0');
            updateStatus('pixhawkStatus', '‚ùå –ù–µ–≤—ñ–¥–æ–º–æ');
            
            connectBtn.disabled = false;
            disconnectBtn.disabled = true;
            requestVideoBtn.disabled = true;
            stopVideoBtn.disabled = true;
            // robotControls.style.display = 'none'; // –í–∏–¥–∞–ª–µ–Ω–æ
            
            log('‚úÖ –í—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ');
        }

        // –§—É–Ω–∫—Ü—ñ—ó –∫–µ—Ä—É–≤–∞–Ω–Ω—è –≤—ñ–¥–µ–æ
        function requestVideo() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('‚ùå WebSocket –Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ', 'error');
                return;
            }
            
            log('üìπ –ó–∞–ø–∏—Ç—É—î–º–æ –≤—ñ–¥–µ–æ–ø–æ—Ç—ñ–∫...');
            
            // –°—Ç–≤–æ—Ä—é—î–º–æ —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π ID —Å–µ—Å—ñ—ó
            const sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ WebRTC –ø–µ—Ä–µ–¥ –∑–∞–ø–∏—Ç–æ–º
            initWebRTC(sessionId);
            
            // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –∑–∞–ø–∏—Ç –≤—ñ–¥–µ–æ —Ä–æ–±–æ—Ç—É
            ws.send(JSON.stringify({
                type: 'webrtc-signal',
                signalType: 'request_video',
                sessionId: sessionId,
                data: {}
            }));
            
            log(`üé¨ –ó–∞–ø–∏—Ç –≤—ñ–¥–µ–æ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –∑ ID —Å–µ—Å—ñ—ó: ${sessionId}`);
        }
        
        function stopVideo() {
            log('‚èπÔ∏è –ó—É–ø–∏–Ω—è—î–º–æ –≤—ñ–¥–µ–æ...');
            
            if (pc) {
                pc.close();
                pc = null;
            }
            
            currentSessionId = null;
            videoElement.srcObject = null;
            updateStatus('iceStatus', '‚ùå –í—ñ–¥–∫–ª—é—á–µ–Ω–æ');
            updateStatus('videoStatus', '‚ùå –ó—É–ø–∏–Ω–µ–Ω–æ');
            updateStatus('framesCount', '0');
            
            requestVideoBtn.disabled = false;
            stopVideoBtn.disabled = true;
        }
        
        // –§—É–Ω–∫—Ü—ñ—ó –∫–µ—Ä—É–≤–∞–Ω–Ω—è —Ä–æ–±–æ—Ç–æ–º
        function sendCommand(command) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('‚ùå WebSocket –Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥–∏', 'error');
                return;
            }
            
            log(`üéÆ –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –∫–æ–º–∞–Ω–¥—É: ${command}`);
            
            // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –∫–æ–º–∞–Ω–¥—É –≤ —Ñ–æ—Ä–º–∞—Ç—ñ, —è–∫–∏–π —Ä–æ–±–æ—Ç —Ä–æ–∑—É–º—ñ—î
            const commandMessage = `COMMAND!${JSON.stringify({
                type: 'control',
                command: command,
                timestamp: Date.now()
            })}`;
            
            ws.send(commandMessage);
        }
        
        // –ö–µ—Ä—É–≤–∞–Ω–Ω—è –∑ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∏
        document.addEventListener('keydown', (event) => {
            // if (robotControls.style.display === 'none') return; // –í–∏–¥–∞–ª–µ–Ω–æ
            
            switch(event.code) {
                // case 'ArrowUp': // –í–∏–¥–∞–ª–µ–Ω–æ
                // case 'KeyW': // –í–∏–¥–∞–ª–µ–Ω–æ
                //     event.preventDefault(); // –í–∏–¥–∞–ª–µ–Ω–æ
                //     sendCommand('MOVE_FORWARD'); // –í–∏–¥–∞–ª–µ–Ω–æ
                //     break; // –í–∏–¥–∞–ª–µ–Ω–æ
                // case 'ArrowDown': // –í–∏–¥–∞–ª–µ–Ω–æ
                // case 'KeyS': // –í–∏–¥–∞–ª–µ–Ω–æ
                //     event.preventDefault(); // –í–∏–¥–∞–ª–µ–Ω–æ
                //     sendCommand('MOVE_BACKWARD'); // –í–∏–¥–∞–ª–µ–Ω–æ
                //     break; // –í–∏–¥–∞–ª–µ–Ω–æ
                // case 'ArrowLeft': // –í–∏–¥–∞–ª–µ–Ω–æ
                // case 'KeyA': // –í–∏–¥–∞–ª–µ–Ω–æ
                //     event.preventDefault(); // –í–∏–¥–∞–ª–µ–Ω–æ
                //     sendCommand('TURN_LEFT'); // –í–∏–¥–∞–ª–µ–Ω–æ
                //     break; // –í–∏–¥–∞–ª–µ–Ω–æ
                // case 'ArrowRight': // –í–∏–¥–∞–ª–µ–Ω–æ
                // case 'KeyD': // –í–∏–¥–∞–ª–µ–Ω–æ
                //     event.preventDefault(); // –í–∏–¥–∞–ª–µ–Ω–æ
                //     sendCommand('TURN_RIGHT'); // –í–∏–¥–∞–ª–µ–Ω–æ
                //     break; // –í–∏–¥–∞–ª–µ–Ω–æ
                // case 'Space': // –í–∏–¥–∞–ª–µ–Ω–æ
                //     event.preventDefault(); // –í–∏–¥–∞–ª–µ–Ω–æ
                //     sendCommand('STOP'); // –í–∏–¥–∞–ª–µ–Ω–æ
                //     break; // –í–∏–¥–∞–ª–µ–Ω–æ
            }
        });
        
        // –ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è TURN —Ä–µ–∂–∏–º—É
        function toggleTurnMode() {
            turnModeEnabled = !turnModeEnabled;
            
            if (turnModeEnabled) {
                log('üîÑ TURN —Ä–µ–∂–∏–º –í–ö–õ–Æ–ß–ï–ù–û: –ø—Ä–∏–º—É—Å–æ–≤–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è TURN relay', 'connected');
                log('   –ù–∞—Å—Ç—É–ø–Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –±—É–¥–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —Ç—ñ–ª—å–∫–∏ TURN —Å–µ—Ä–≤–µ—Ä–∏');
            } else {
                log('üîÑ TURN —Ä–µ–∂–∏–º –í–ò–ú–ö–ù–ï–ù–û: –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –≤–∏–±—ñ—Ä –∑\'—î–¥–Ω–∞–Ω–Ω—è', 'info');
                log('   –ë—Ä–∞—É–∑–µ—Ä –±—É–¥–µ –≤–∏–±–∏—Ä–∞—Ç–∏ –æ–ø—Ç–∏–º–∞–ª—å–Ω–∏–π —Ç–∏–ø –∑\'—î–¥–Ω–∞–Ω–Ω—è (STUN/TURN/–ø—Ä—è–º–µ)');
            }
            
            updateTurnButtonAppearance();
            
            // –Ø–∫—â–æ –≤–∂–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω—ñ, –ø–æ–∫–∞–∑—É—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è
            if (pc && pc.connectionState === 'connected') {
                log('‚ö†Ô∏è –î–ª—è –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –∑–º—ñ–Ω –ø–µ—Ä–µ–ø—ñ–¥–∫–ª—é—á—ñ—Ç—å—Å—è –¥–æ —Ä–æ–±–æ—Ç–∞', 'error');
            }
        }
        
        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–æ–≤–Ω—ñ—à–Ω—å–æ–≥–æ –≤–∏–≥–ª—è–¥—É –∫–Ω–æ–ø–∫–∏ TURN
        function updateTurnButtonAppearance() {
            if (turnModeEnabled) {
                turnToggleBtn.textContent = 'üîÑ TURN –í–ö–õ';
                turnToggleBtn.className = '';
                turnToggleBtn.title = 'TURN —Ä–µ–∂–∏–º –≤–∫–ª—é—á–µ–Ω–æ - –ø—Ä–∏–º—É—Å–æ–≤–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è TURN —Å–µ—Ä–≤–µ—Ä—ñ–≤. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –¥–ª—è –≤–∏–º–∫–Ω–µ–Ω–Ω—è.';
            } else {
                turnToggleBtn.textContent = 'üîÑ TURN –í–ò–ú–ö–ù–ï–ù–û';
                turnToggleBtn.className = 'disabled';
                turnToggleBtn.title = 'TURN —Ä–µ–∂–∏–º –≤–∏–º–∫–Ω–µ–Ω–∏–π - –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –≤–∏–±—ñ—Ä –∑\'—î–¥–Ω–∞–Ω–Ω—è. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –¥–ª—è –≤–∫–ª—é—á–µ–Ω–Ω—è.';
            }
        }
        
        // –ê–≤—Ç–æ-–ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏ (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)
        // window.addEventListener('load', startConnection);

        // –ü–æ–∫—Ä–∞—â–µ–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è TURN —Å–µ—Ä–≤–µ—Ä–∞
        async function checkTurnUsage() {
            if (!pc) return;
            
            try {
                const stats = await pc.getStats();
                let usingTurn = false;
                let connectionDetails = {
                    local: { type: '', address: '', port: '', protocol: '' },
                    remote: { type: '', address: '', port: '', protocol: '' }
                };
                let selectedPair = null;
                
                // –°–ø–æ—á–∞—Ç–∫—É –∑–Ω–∞–π–¥–µ–º–æ –∞–∫—Ç–∏–≤–Ω—É –ø–∞—Ä—É –∫–∞–Ω–¥–∏–¥–∞—Ç—ñ–≤
                stats.forEach(report => {
                    if (report.type === 'candidate-pair' && 
                        (report.state === 'succeeded' || report.nominated)) {
                        selectedPair = report;
                    }
                });
                
                if (selectedPair) {
                    // –ó–Ω–∞–π–¥–µ–º–æ –¥–µ—Ç–∞–ª—ñ –∫–∞–Ω–¥–∏–¥–∞—Ç—ñ–≤ —É –≤–∏–±—Ä–∞–Ω—ñ–π –ø–∞—Ä—ñ
                    stats.forEach(report => {
                        if (report.type === 'local-candidate' && report.id === selectedPair.localCandidateId) {
                            connectionDetails.local = {
                                type: report.candidateType,
                                address: report.address,
                                port: report.port,
                                protocol: report.protocol
                            };
                        }
                        if (report.type === 'remote-candidate' && report.id === selectedPair.remoteCandidateId) {
                            connectionDetails.remote = {
                                type: report.candidateType,
                                address: report.address,
                                port: report.port,
                                protocol: report.protocol
                            };
                        }
                    });
                    
                    // –í–∏–∑–Ω–∞—á–∞—î–º–æ —Ç–∏–ø –∑'—î–¥–Ω–∞–Ω–Ω—è
                    if (connectionDetails.local.type === 'relay' || connectionDetails.remote.type === 'relay') {
                        usingTurn = true;
                        const turnSide = connectionDetails.local.type === 'relay' ? 'local' : 'remote';
                        const turnDetails = connectionDetails[turnSide];
                        
                        log(`üîÑ TURN relay –ê–ö–¢–ò–í–ù–ò–ô! (${turnDetails.protocol}:${turnDetails.address}:${turnDetails.port})`, 'connected');
                        log(`   –õ–æ–∫–∞–ª—å–Ω–∏–π: ${connectionDetails.local.type} ${connectionDetails.local.address}:${connectionDetails.local.port}`);
                        log(`   –í—ñ–¥–¥–∞–ª–µ–Ω–∏–π: ${connectionDetails.remote.type} ${connectionDetails.remote.address}:${connectionDetails.remote.port}`);
                        updateStatus('iceStatus', 'üîÑ TURN –∞–∫—Ç–∏–≤–Ω–∏–π', true);
                        
                        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —â–æ —Ü–µ —Å–∞–º–µ –Ω–∞—à TURN —Å–µ—Ä–≤–µ—Ä
                        if (turnDetails.address === '193.169.240.11') {
                            log(`‚úÖ –ü–Ü–î–¢–í–ï–†–î–ñ–ï–ù–û: –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –ù–ê–®–ê TURN-—ñ–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞!`, 'connected');
                        }
                        
                    } else if (connectionDetails.local.type === 'srflx' || connectionDetails.remote.type === 'srflx') {
                        log(`üßä STUN –∑'—î–¥–Ω–∞–Ω–Ω—è: ${connectionDetails.local.type} <-> ${connectionDetails.remote.type}`);
                        log(`   –ê–¥—Ä–µ—Å–∏: ${connectionDetails.local.address}:${connectionDetails.local.port} <-> ${connectionDetails.remote.address}:${connectionDetails.remote.port}`);
                        updateStatus('iceStatus', 'üßä STUN –∞–∫—Ç–∏–≤–Ω–∏–π', true);
                        
                    } else {
                        log(`üè† –ü—Ä—è–º–µ –∑'—î–¥–Ω–∞–Ω–Ω—è: ${connectionDetails.local.address}:${connectionDetails.local.port} <-> ${connectionDetails.remote.address}:${connectionDetails.remote.port}`);
                        updateStatus('iceStatus', 'üè† –ü—Ä—è–º–µ', true);
                    }
                } else {
                    log('‚ö†Ô∏è –ê–∫—Ç–∏–≤–Ω–∞ –ø–∞—Ä–∞ –∫–∞–Ω–¥–∏–¥–∞—Ç—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞', 'error');
                    updateStatus('iceStatus', '‚ùå –ù–µ–º–∞—î –∑\'—î–¥–Ω–∞–Ω–Ω—è', false);
                }
                
                // –ó–∞–≥–∞–ª—å–Ω–∏–π –∞–Ω–∞–ª—ñ–∑ –≤—Å—ñ—Ö –∫–∞–Ω–¥–∏–¥–∞—Ç—ñ–≤
                let allCandidates = {relay: 0, srflx: 0, host: 0, total: 0};
                stats.forEach(report => {
                    if (report.type === 'local-candidate' || report.type === 'remote-candidate') {
                        allCandidates.total++;
                        allCandidates[report.candidateType] = (allCandidates[report.candidateType] || 0) + 1;
                    }
                });
                
                log(`üìä –ê–Ω–∞–ª—ñ–∑ –∫–∞–Ω–¥–∏–¥–∞—Ç—ñ–≤: –≤—Å—å–æ–≥–æ ${allCandidates.total} (relay: ${allCandidates.relay || 0}, srflx: ${allCandidates.srflx || 0}, host: ${allCandidates.host || 0})`);
                
                // –ü–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è –¥–ª—è TURN —Ä–µ–∂–∏–º—É
                if (!usingTurn && rtcConfig.iceTransportPolicy === 'relay') {
                    log(`‚ö†Ô∏è –£–í–ê–ì–ê: TURN —Ä–µ–∂–∏–º –≤–∫–ª—é—á–µ–Ω–æ, –∞–ª–µ TURN –Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è!`, 'error');
                    log(`üîß –ú–æ–∂–ª–∏–≤–∞ –ø—Ä–æ–±–ª–µ–º–∞ –∑ TURN —Å–µ—Ä–≤–µ—Ä–æ–º –∞–±–æ credentials!`, 'error');
                }
                
                // –î–æ–¥–∞—Ç–∫–æ–≤–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                logConnectionStats(stats);
                
            } catch (error) {
                log(`‚ùå –ü–æ–º–∏–ª–∫–∞ –∞–Ω–∞–ª—ñ–∑—É TURN: ${error.message}`, 'error');
            }
        }

        // –õ–æ–≥—É–≤–∞–Ω–Ω—è –¥–µ—Ç–∞–ª—å–Ω–æ—ó —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∑'—î–¥–Ω–∞–Ω–Ω—è
        function logConnectionStats(stats) {
            let bytesReceived = 0;
            let bytesSent = 0;
            let packetsReceived = 0;
            let packetsSent = 0;
            
            stats.forEach(report => {
                if (report.type === 'inbound-rtp' && report.mediaType === 'video') {
                    bytesReceived += report.bytesReceived || 0;
                    packetsReceived += report.packetsReceived || 0;
                } else if (report.type === 'outbound-rtp' && report.mediaType === 'video') {
                    bytesSent += report.bytesSent || 0;
                    packetsSent += report.packetsSent || 0;
                }
            });
            
            if (bytesReceived > 0) {
                log(`üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: –æ—Ç—Ä–∏–º–∞–Ω–æ ${Math.round(bytesReceived/1024)}KB, ${packetsReceived} –ø–∞–∫–µ—Ç—ñ–≤`);
            }
        }

        // –ü–µ—Ä—ñ–æ–¥–∏—á–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å—É TURN
        function startTurnMonitoring() {
            if (pc) {
                // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∫–æ–∂–Ω—ñ 5 —Å–µ–∫—É–Ω–¥
                const turnMonitorInterval = setInterval(() => {
                    if (!pc || pc.connectionState === 'closed') {
                        clearInterval(turnMonitorInterval);
                        return;
                    }
                    checkTurnUsage();
                }, 5000);
            }
        }
        

        
        // –°–£–ü–ï–†-–î–Ü–ê–ì–ù–û–°–¢–ò–ö–ê: –î–µ—Ç–∞–ª—å–Ω–∏–π –∞–Ω–∞–ª—ñ–∑ RTCPeerConnection
        async function analyzeConnectionDetails() {
            if (!pc) return;
            
            try {
                log('üî¨ –î–ï–¢–ê–õ–¨–ù–ê –î–Ü–ê–ì–ù–û–°–¢–ò–ö–ê RTCPeerConnection:');
                
                // 1. –°—Ç–∞–Ω –∑'—î–¥–Ω–∞–Ω–Ω—è
                log(`   –°—Ç–∞–Ω –∑'—î–¥–Ω–∞–Ω–Ω—è: ${pc.connectionState}`);
                log(`   –°—Ç–∞–Ω ICE: ${pc.iceConnectionState}`);
                log(`   –°—Ç–∞–Ω ICE –∑–±—ñ—Ä: ${pc.iceGatheringState}`);
                log(`   –°—Ç–∞–Ω —Å–∏–≥–Ω–∞–ª—ñ–Ω–≥—É: ${pc.signalingState}`);
                
                // 2. –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é TURN
                const config = pc.getConfiguration();
                const turnServers = config.iceServers?.filter(s => {
                    const urls = Array.isArray(s.urls) ? s.urls : [s.urls];
                    return urls.some(url => url && (url.startsWith('turn:') || url.startsWith('turns:')));
                }) || [];
                
                log(`üî¨ TURN —Å–µ—Ä–≤–µ—Ä—ñ–≤ —É –∞–∫—Ç–∏–≤–Ω–æ–º—É –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó: ${turnServers.length}`);
                turnServers.forEach((server, i) => {
                    const urls = Array.isArray(server.urls) ? server.urls : [server.urls];
                    urls.forEach((url, j) => {
                        if (url && (url.startsWith('turn:') || url.startsWith('turns:'))) {
                            log(`   TURN ${i+1}.${j+1}: ${url}`);
                            log(`     –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á: "${server.username || '–ù–ï–¢'}" | –ü–∞—Ä–æ–ª—å: ${server.credential ? '–Ñ' : '–ù–ï–¢'}`);
                        }
                    });
                });
                
                // 3. –ê–Ω–∞–ª—ñ–∑ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                const stats = await pc.getStats();
                analyzeStatsDetailed(stats);
                
            } catch (error) {
                log(`‚ùå –ü–æ–º–∏–ª–∫–∞ –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –∑'—î–¥–Ω–∞–Ω–Ω—è: ${error.message}`, 'error');
            }
        }
        
        // –°–£–ü–ï–†-–î–Ü–ê–ì–ù–û–°–¢–ò–ö–ê: –ê–Ω–∞–ª—ñ–∑ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ñ–≤ —Ç–∞ –ø–∞—Ä
        async function analyzeICECandidatePairs() {
            if (!pc) return;
            
            try {
                log('üßä –î–ï–¢–ê–õ–¨–ù–ò–ô –ê–ù–ê–õ–Ü–ó ICE –ö–ê–ù–î–ò–î–ê–¢–Ü–í:');
                const stats = await pc.getStats();
                
                let localCandidates = [];
                let remoteCandidates = [];
                let candidatePairs = [];
                
                // –ó–±–∏—Ä–∞—î–º–æ –≤—Å—ñ –∫–∞–Ω–¥–∏–¥–∞—Ç–∏ —Ç–∞ –ø–∞—Ä–∏
                stats.forEach(report => {
                    if (report.type === 'local-candidate') {
                        localCandidates.push(report);
                    } else if (report.type === 'remote-candidate') {
                        remoteCandidates.push(report);
                    } else if (report.type === 'candidate-pair') {
                        candidatePairs.push(report);
                    }
                });
                
                log(`üìä –ó–Ω–∞–π–¥–µ–Ω–æ: ${localCandidates.length} –ª–æ–∫–∞–ª—å–Ω–∏—Ö, ${remoteCandidates.length} –≤—ñ–¥–¥–∞–ª–µ–Ω–∏—Ö –∫–∞–Ω–¥–∏–¥–∞—Ç—ñ–≤, ${candidatePairs.length} –ø–∞—Ä`);
                
                // –ê–Ω–∞–ª—ñ–∑ –ª–æ–∫–∞–ª—å–Ω–∏—Ö –∫–∞–Ω–¥–∏–¥–∞—Ç—ñ–≤
                log('üè† –õ–û–ö–ê–õ–¨–ù–Ü –ö–ê–ù–î–ò–î–ê–¢–ò:');
                localCandidates.forEach((candidate, i) => {
                    const turnInfo = candidate.candidateType === 'relay' ? 
                        ` (TURN relay –≤—ñ–¥ ${candidate.relayProtocol || '–Ω–µ–≤—ñ–¥–æ–º–æ'})` : '';
                    log(`   ${i+1}. ${candidate.candidateType} ${candidate.address}:${candidate.port} ${candidate.protocol}${turnInfo}`);
                    
                    // –°–ø–µ—Ü—ñ–∞–ª—å–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–ª—è TURN
                    if (candidate.candidateType === 'relay' && candidate.address === '193.169.240.11') {
                        log(`     ‚úÖ –ü–Ü–î–¢–í–ï–†–î–ñ–ï–ù–û: –¶–µ –Ω–∞—à TURN —Å–µ—Ä–≤–µ—Ä!`);
                    }
                });
                
                // –ê–Ω–∞–ª—ñ–∑ –≤—ñ–¥–¥–∞–ª–µ–Ω–∏—Ö –∫–∞–Ω–¥–∏–¥–∞—Ç—ñ–≤  
                log('üåê –í–Ü–î–î–ê–õ–ï–ù–Ü –ö–ê–ù–î–ò–î–ê–¢–ò:');
                remoteCandidates.forEach((candidate, i) => {
                    const turnInfo = candidate.candidateType === 'relay' ? 
                        ` (TURN relay –≤—ñ–¥ ${candidate.relayProtocol || '–Ω–µ–≤—ñ–¥–æ–º–æ'})` : '';
                    log(`   ${i+1}. ${candidate.candidateType} ${candidate.address}:${candidate.port} ${candidate.protocol}${turnInfo}`);
                    
                    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤—ñ–¥–¥–∞–ª–µ–Ω–æ–≥–æ TURN (–≤—ñ–¥ —Ä–æ–±–æ—Ç–∞)
                    if (candidate.candidateType === 'relay' && candidate.address === '193.169.240.11') {
                        log(`     ‚úÖ –ü–Ü–î–¢–í–ï–†–î–ñ–ï–ù–û: –†–æ–±–æ—Ç –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –Ω–∞—à TURN —Å–µ—Ä–≤–µ—Ä!`);
                    }
                });
                
                // –ê–Ω–∞–ª—ñ–∑ –ø–∞—Ä –∫–∞–Ω–¥–∏–¥–∞—Ç—ñ–≤
                log('üîó –ü–ê–†–ò –ö–ê–ù–î–ò–î–ê–¢–Ü–í:');
                let activePair = null;
                candidatePairs.forEach((pair, i) => {
                    const state = pair.state || 'unknown';
                    const nominated = pair.nominated ? 'üèÜ –í–ò–ë–†–ê–ù–ê' : '';
                    const active = (state === 'succeeded' || pair.nominated) ? '‚úÖ' : '‚è∏Ô∏è';
                    
                    log(`   ${i+1}. ${active} –°—Ç–∞–Ω: ${state} ${nominated}`);
                    log(`      –í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ: ${pair.requestsSent || 0} | –û—Ç—Ä–∏–º–∞–Ω–æ: ${pair.responsesReceived || 0}`);
                    
                    if (state === 'succeeded' || pair.nominated) {
                        activePair = pair;
                        
                        // –ó–Ω–∞–π–¥–µ–º–æ –¥–µ—Ç–∞–ª—ñ –∞–∫—Ç–∏–≤–Ω–æ—ó –ø–∞—Ä–∏
                        const localCand = localCandidates.find(c => c.id === pair.localCandidateId);
                        const remoteCand = remoteCandidates.find(c => c.id === pair.remoteCandidateId);
                        
                        if (localCand && remoteCand) {
                            log(`      üéØ –ê–ö–¢–ò–í–ù–ï –ó'–Ñ–î–ù–ê–ù–ù–Ø:`);
                            log(`         –õ–æ–∫–∞–ª—å–Ω–∏–π: ${localCand.candidateType} ${localCand.address}:${localCand.port}`);
                            log(`         –í—ñ–¥–¥–∞–ª–µ–Ω–∏–π: ${remoteCand.candidateType} ${remoteCand.address}:${remoteCand.port}`);
                            
                            // –í–∏–∑–Ω–∞—á–∞—î–º–æ —Ç–∏–ø –∑'—î–¥–Ω–∞–Ω–Ω—è
                            if (localCand.candidateType === 'relay' || remoteCand.candidateType === 'relay') {
                                log(`      üîÑ TURN RELAY –ó'–Ñ–î–ù–ê–ù–ù–Ø –ê–ö–¢–ò–í–ù–ï!`, 'connected');
                                if (localCand.address === '193.169.240.11' || remoteCand.address === '193.169.240.11') {
                                    log(`      ‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –ù–ê–® TURN —Å–µ—Ä–≤–µ—Ä: 193.169.240.11`, 'connected');
                                }
                            } else if (localCand.candidateType === 'srflx' || remoteCand.candidateType === 'srflx') {
                                log(`      üßä STUN –∑'—î–¥–Ω–∞–Ω–Ω—è`);
                            } else {
                                log(`      üè† –ü—Ä—è–º–µ –∑'—î–¥–Ω–∞–Ω–Ω—è`);
                            }
                        }
                    }
                });
                
                // –ó–∞–≥–∞–ª—å–Ω–∏–π –∞–Ω–∞–ª—ñ–∑
                if (!activePair) {
                    log('‚ùå –ù–ï–ú–ê–Ñ –ê–ö–¢–ò–í–ù–û–á –ü–ê–†–ò –ö–ê–ù–î–ò–î–ê–¢–Ü–í!', 'error');
                    if (turnModeEnabled) {
                        log('üîß –î–Ü–ê–ì–ù–û–°–¢–ò–ö–ê TURN: –ó\'—î–¥–Ω–∞–Ω–Ω—è –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!', 'error');
                        log('   –ú–æ–∂–ª–∏–≤—ñ –ø—Ä–∏—á–∏–Ω–∏:');
                        log('   1. TURN —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π');
                        log('   2. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ñ credentials (robotclient:robotclient2024)');
                        log('   3. –ú–µ—Ä–µ–∂–µ–≤—ñ –æ–±–º–µ–∂–µ–Ω–Ω—è/—Ñ–∞–π—Ä–µ–≤–æ–ª');
                        log('   4. TURN —Å–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∏–π –¥–ª—è relay');
                    }
                } else {
                    log('‚úÖ –ê–∫—Ç–∏–≤–Ω–∞ –ø–∞—Ä–∞ –∑–Ω–∞–π–¥–µ–Ω–∞ —Ç–∞ –ø—Ä–æ–∞–Ω–∞–ª—ñ–∑–æ–≤–∞–Ω–∞');
                    if (turnModeEnabled) {
                        // –î–æ–¥–∞—Ç–∫–æ–≤–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–ª—è TURN —Ä–µ–∂–∏–º—É
                        const localCand = localCandidates.find(c => c.id === activePair.localCandidateId);
                        const remoteCand = remoteCandidates.find(c => c.id === activePair.remoteCandidateId);
                        
                        if (localCand?.candidateType === 'relay' || remoteCand?.candidateType === 'relay') {
                            log('‚úÖ TURN –î–Ü–ê–ì–ù–û–°–¢–ò–ö–ê: –£–°–ü–Ü–•! TURN —Å–µ—Ä–≤–µ—Ä–∏ –ø—Ä–∞—Ü—é—é—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ!', 'connected');
                            log('üéØ TURN credentials —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω—ñ: robotclient:robotclient2024', 'connected');
                        } else {
                            log('‚ùå TURN –î–Ü–ê–ì–ù–û–°–¢–ò–ö–ê: –ü–†–û–í–ê–õ! –ù–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è relay!', 'error');
                            log('üîß TURN —Ä–µ–∂–∏–º –≤–∫–ª—é—á–µ–Ω–æ, –∞–ª–µ –∑\'—î–¥–Ω–∞–Ω–Ω—è –Ω–µ —á–µ—Ä–µ–∑ TURN!', 'error');
                        }
                    }
                }
                
            } catch (error) {
                log(`‚ùå –ü–æ–º–∏–ª–∫–∞ –∞–Ω–∞–ª—ñ–∑—É ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ñ–≤: ${error.message}`, 'error');
            }
        }
        
        // –î–µ—Ç–∞–ª—å–Ω–∏–π –∞–Ω–∞–ª—ñ–∑ WebRTC —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function analyzeStatsDetailed(stats) {
            log('üìä –î–ï–¢–ê–õ–¨–ù–ê –°–¢–ê–¢–ò–°–¢–ò–ö–ê:');
            
            let inboundVideo = null;
            let transport = null;
            
            stats.forEach(report => {
                if (report.type === 'inbound-rtp' && report.mediaType === 'video') {
                    inboundVideo = report;
                } else if (report.type === 'transport') {
                    transport = report;
                }
            });
            
            // –í—ñ–¥–µ–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            if (inboundVideo) {
                log(`üìπ –í—ñ–¥–µ–æ–ø–æ—Ç—ñ–∫:`);
                log(`   –û—Ç—Ä–∏–º–∞–Ω–æ: ${inboundVideo.bytesReceived || 0} –±–∞–π—Ç, ${inboundVideo.packetsReceived || 0} –ø–∞–∫–µ—Ç—ñ–≤`);
                log(`   –ö–∞–¥—Ä–∏: ${inboundVideo.framesReceived || 0} –æ—Ç—Ä–∏–º–∞–Ω–æ, ${inboundVideo.framesDecoded || 0} –¥–µ–∫–æ–¥–æ–≤–∞–Ω–æ`);
                log(`   –í—Ç—Ä–∞—Ç–∏: ${inboundVideo.packetsLost || 0} –ø–∞–∫–µ—Ç—ñ–≤`);
            }
            
            // –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            if (transport) {
                log(`üåê –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç:`);
                log(`   –í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ: ${transport.bytesSent || 0} –±–∞–π—Ç, ${transport.packetsSent || 0} –ø–∞–∫–µ—Ç—ñ–≤`);
                log(`   –û—Ç—Ä–∏–º–∞–Ω–æ: ${transport.bytesReceived || 0} –±–∞–π—Ç, ${transport.packetsReceived || 0} –ø–∞–∫–µ—Ç—ñ–≤`);
                
                if (transport.selectedCandidatePairId) {
                    log(`   –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –ø–∞—Ä–∞ –∫–∞–Ω–¥–∏–¥–∞—Ç—ñ–≤: ${transport.selectedCandidatePairId}`);
                }
            }
        }

        // 3. JS: –¥–æ–¥–∞—Ç–∏ –∑–º—ñ–Ω–Ω—ñ —Ç–∞ —Ñ—É–Ω–∫—Ü—ñ—ó –¥–ª—è –≥–µ–π–º–ø–∞–¥–∞
        let gamepadIndex = null;
        let gamepadConnected = false;
        let gamepadInterval = null;

        function connectGamepad() {
            window.addEventListener('gamepadconnected', onGamepadConnected);
            window.addEventListener('gamepaddisconnected', onGamepadDisconnected);
            // –°–ø—Ä–æ–±—É–≤–∞—Ç–∏ –∑–Ω–∞–π—Ç–∏ –≤–∂–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–∏–π –≥–µ–π–º–ø–∞–¥
            const gps = navigator.getGamepads();
            for (let i = 0; i < gps.length; i++) {
                if (gps[i]) {
                    onGamepadConnected({gamepad: gps[i]});
                    break;
                }
            }
            log('‚å®Ô∏è –û—á—ñ–∫—É–≤–∞–Ω–Ω—è –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –≥–µ–π–º–ø–∞–¥–∞...');
        }

        function onGamepadConnected(e) {
            gamepadIndex = e.gamepad.index;
            gamepadConnected = true;
            updateStatus('gamepadStatus', 'üéÆ', true);
            document.getElementById('gamepadLabel').textContent = e.gamepad.id;
            log('üéÆ –ì–µ–π–º–ø–∞–¥ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ: ' + e.gamepad.id, 'connected');
            if (gamepadInterval) clearInterval(gamepadInterval);
            gamepadInterval = setInterval(pollGamepad, 50);
        }

        function onGamepadDisconnected(e) {
            gamepadConnected = false;
            updateStatus('gamepadStatus', '‚ùå', false);
            document.getElementById('gamepadLabel').textContent = '';
            log('‚ùå –ì–µ–π–º–ø–∞–¥ –≤—ñ–¥–∫–ª—é—á–µ–Ω–æ', 'error');
            if (gamepadInterval) clearInterval(gamepadInterval);
        }

        function pollGamepad() {
            const gp = navigator.getGamepads()[gamepadIndex];
            if (!gp) return;
            // –ü—Ä–∏–∫–ª–∞–¥: —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ñ –æ—Å—ñ –¥–ª—è Xbox/PS –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ñ–≤
            const leftX = gp.axes[0] || 0;
            const leftY = gp.axes[1] || 0;
            const rightX = gp.axes[2] || 0;
            const rightY = gp.axes[3] || 0;
            // –ü—Ä–∏–∫–ª–∞–¥: –∫—É—Ç –∫–∞–º–µ—Ä–∏ –ø–æ —Ç—Ä–∏–≥–µ—Ä—É (–∞–±–æ —ñ–Ω—à–æ—ó –æ—Å—ñ/–∫–Ω–æ–ø–∫–∏)
            let cameraAngle = 0;
            if (gp.buttons[6]) cameraAngle = gp.buttons[6].value * 90; // LT —è–∫ –ø—Ä–∏–∫–ª–∞–¥
            // –§–æ—Ä–º—É—î–º–æ –∫–æ–º–∞–Ω–¥—É
            const command = {
                leftStickValue: { x: +leftX.toFixed(2), y: +leftY.toFixed(2) },
                rightStickValue: { x: +rightX.toFixed(2), y: +rightY.toFixed(2) },
                cameraAngle: +cameraAngle.toFixed(2)
            };
            // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ WebSocket –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send('COMMAND!' + JSON.stringify(command));
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞–∑–≤–æ—Ä–æ—Ç–∞ –≤–∏–¥–µ–æ –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
        function toggleFullscreen() {
            const video = document.getElementById('videoElement');
            if (!document.fullscreenElement) {
                if (video.requestFullscreen) {
                    video.requestFullscreen();
                } else if (video.webkitRequestFullscreen) { /* Safari */
                    video.webkitRequestFullscreen();
                } else if (video.msRequestFullscreen) { /* IE11 */
                    video.msRequestFullscreen();
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
            }
        }
    </script>
</body>
</html> 