# Архитектура WebRTC Сигналинг Сервера

Сервер был рефакторен согласно принципам SOLID для улучшения поддерживаемости, тестируемости и расширяемости. Основная цель - обеспечить WebRTC сигналинг между роботом и Unity клиентом.

## Структура проекта

```
server/src/
├── index.js                          # Точка входа
├── ServerManager.js                  # Главный класс управления сервером
├── config/
│   └── ServerConfig.js               # Конфигурация сервера
├── services/
│   ├── ClientManagerService.js       # Управление WebSocket клиентами
│   ├── WebRTCSignalingService.js     # WebRTC сигналинг
│   └── WebSocketService.js           # WebSocket сервер
├── handlers/
│   └── MessageHandler.js             # Обработка сообщений
└── routes/
    └── ApiRoutes.js                  # API маршруты
```

## Принципы SOLID

### Single Responsibility Principle (SRP)
Каждый класс имеет одну ответственность:
- `ClientManagerService` - управление клиентами
- `WebRTCSignalingService` - WebRTC сигналинг
- `MessageHandler` - обработка сообщений
- `WebSocketService` - WebSocket сервер
- `ApiRoutes` - API маршруты

### Open/Closed Principle (OCP)
Классы открыты для расширения, закрыты для модификации:
- Новые типы WebRTC сигналов легко добавляются в `WebRTCSignalingService`
- Новые типы сообщений легко добавляются в `MessageHandler`
- Новые API эндпоинты добавляются в `ApiRoutes`

### Liskov Substitution Principle (LSP)
Сервисы могут быть заменены альтернативными реализациями без нарушения функциональности.

### Interface Segregation Principle (ISP)
Классы зависят только от нужных им методов через инъекцию зависимостей.

### Dependency Inversion Principle (DIP)
Высокоуровневые модули не зависят от низкоуровневых. Все зависимости инжектируются через конструкторы.

## Компоненты

### ServerManager
Главный класс, управляющий жизненным циклом сервера:
- Инициализация всех сервисов
- Настройка Express приложения
- Graceful shutdown
- Обработка ошибок
- Управление WebRTC конфигурацией

### ClientManagerService
Управление WebSocket клиентами:
- Регистрация/отключение клиентов
- Определение целевых клиентов для сообщений
- Проверка статуса подключений
- Отправка сообщений клиентам

### WebRTCSignalingService
Обработка WebRTC сигналинга:
- Обработка offer/answer/ICE кандидатов
- Управление WebRTC сессиями
- Статистика WebRTC соединений
- Очистка старых сессий

### WebSocketService
WebSocket сервер и обработка подключений:
- Настройка WebSocket сервера
- Обработка регистрации клиентов
- Health check и мониторинг
- Graceful shutdown WebSocket соединений

### MessageHandler
Обработка различных типов сообщений:
- Команды управления роботом
- Телеметрия
- WebRTC сигналы
- Управление соединениями

### ApiRoutes
REST API эндпоинты:
- Статистика WebRTC сессий
- Управление соединениями
- Health check
- Конфигурация WebRTC

### ServerConfig
Централизованная конфигурация:
- Порты и таймауты
- Интервалы обновления
- Переменные окружения

## API Эндпоинты

### GET /api/status
Основная информация о сервере и подключениях.

### GET /api/status/detailed
Детальная статистика включая WebRTC сессии.

### GET /api/webrtc/stats
Статистика WebRTC сигналинга.

### GET /api/webrtc/sessions
Активные WebRTC сессии.

### GET /api/connections
Информация о WebSocket подключениях.

### GET /api/health
Health check эндпоинт.

### GET /api/webrtc/config
Конфигурация WebRTC для клиентов.

## Преимущества новой архитектуры

1. **Модульность** - каждый компонент можно тестировать отдельно
2. **Расширяемость** - легко добавлять новые функции WebRTC
3. **Поддерживаемость** - четкое разделение ответственности
4. **Тестируемость** - инъекция зависимостей упрощает unit-тесты
5. **Конфигурируемость** - централизованная конфигурация
6. **Надежность** - улучшенная обработка ошибок
7. **WebRTC фокус** - специализация на низколатентном видео

## Запуск

```bash
cd server
npm install
npm start
```

Сервер запустится на порту из переменной `PORT` или 8080 по умолчанию.

## Переменные окружения

- `PORT` - порт сервера (по умолчанию 8080)
- `NODE_ENV` - окружение (development/production)
- `LOG_LEVEL` - уровень логирования

## WebRTC Сигналинг

Сервер поддерживает полный цикл WebRTC сигналинга:

1. **Offer** - от робота к контроллеру
2. **Answer** - от контроллера к роботу  
3. **ICE кандидаты** - двунаправленный обмен
4. **Управление сессиями** - создание, мониторинг, завершение

## Мониторинг

- **WebRTC статистика**: `/api/webrtc/stats`
- **Активные сессии**: `/api/webrtc/sessions`
- **Общий статус**: `/api/status/detailed`
- **Health check**: `/api/health` 