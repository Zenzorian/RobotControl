# Архитектура Оптимизированного Сервера

Сервер был рефакторен согласно принципам SOLID для улучшения поддерживаемости, тестируемости и расширяемости.

## Структура проекта

```
server/src/
├── index.js                    # Точка входа
├── ServerManager.js            # Главный класс управления сервером
├── config/
│   └── ServerConfig.js         # Конфигурация сервера
├── services/
│   ├── ClientManagerService.js # Управление WebSocket клиентами
│   ├── VideoStatsService.js    # Статистика видео потока
│   └── WebSocketService.js     # WebSocket сервер
├── handlers/
│   └── MessageHandler.js       # Обработка сообщений
└── routes/
    └── ApiRoutes.js            # API маршруты
```

## Принципы SOLID

### Single Responsibility Principle (SRP)
Каждый класс имеет одну ответственность:
- `ClientManagerService` - управление клиентами
- `VideoStatsService` - статистика видео
- `MessageHandler` - обработка сообщений
- `WebSocketService` - WebSocket сервер
- `ApiRoutes` - API маршруты

### Open/Closed Principle (OCP)
Классы открыты для расширения, закрыты для модификации:
- Новые типы сообщений легко добавляются в `MessageHandler`
- Новые API эндпоинты добавляются в `ApiRoutes`
- Новые метрики добавляются в `VideoStatsService`

### Liskov Substitution Principle (LSP)
Сервисы могут быть заменены альтернативными реализациями без нарушения функциональности.

### Interface Segregation Principle (ISP)
Классы зависят только от нужных им методов через инъекцию зависимостей.

### Dependency Inversion Principle (DIP)
Высокоуровневые модули не зависят от низкоуровневых. Все зависимости инжектируются через конструкторы.

## Компоненты

### ServerManager
Главный класс, управляющий жизненным циклом сервера:
- Инициализация всех сервисов
- Настройка Express приложения
- Graceful shutdown
- Обработка ошибок

### ClientManagerService
Управление WebSocket клиентами:
- Регистрация/отключение клиентов
- Определение целевых клиентов для сообщений
- Проверка статуса подключений
- Отправка сообщений клиентам

### VideoStatsService
Сбор и предоставление статистики видео:
- Подсчет кадров и FPS
- Время начала/окончания стриминга
- Детальная статистика для API

### WebSocketService
WebSocket сервер и обработка подключений:
- Настройка WebSocket сервера
- Обработка регистрации клиентов
- Health check и мониторинг
- Graceful shutdown WebSocket соединений

### MessageHandler
Обработка различных типов сообщений:
- Команды управления роботом
- Телеметрия
- Видео кадры
- Управление видео потоком

### ApiRoutes
REST API эндпоинты:
- Статистика сервера и видео
- Управление видео потоком
- Health check
- Информация о подключениях

### ServerConfig
Централизованная конфигурация:
- Порты и таймауты
- Интервалы обновления
- Переменные окружения

## API Эндпоинты

### GET /api/status
Основная информация о сервере и подключениях.

### GET /api/status/detailed
Детальная статистика включая производительность.

### GET /api/video/stats
Статистика видео потока.

### POST /api/video/control
Управление видео потоком (start/stop).

### GET /api/connections
Информация о WebSocket подключениях.

### GET /api/health
Health check эндпоинт.

## Преимущества новой архитектуры

1. **Модульность** - каждый компонент можно тестировать отдельно
2. **Расширяемость** - легко добавлять новые функции
3. **Поддерживаемость** - четкое разделение ответственности
4. **Тестируемость** - инъекция зависимостей упрощает unit-тесты
5. **Конфигурируемость** - централизованная конфигурация
6. **Надежность** - улучшенная обработка ошибок

## Запуск

```bash
cd server
npm install
npm start
```

Сервер запустится на порту из переменной `PORT` или 8080 по умолчанию.

## Переменные окружения

- `PORT` - порт сервера (по умолчанию 8080)
- `NODE_ENV` - окружение (development/production)
- `LOG_LEVEL` - уровень логирования

## Обратная совместимость

Старые эндпоинты продолжают работать:
- `/status` перенаправляется на `/api/status/detailed`
- Протокол WebSocket остался без изменений 