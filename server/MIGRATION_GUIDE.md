# Руководство по Миграции на SOLID Архитектуру

## Изменения в структуре

### Было (v1.0.0):
```
server/src/
├── optimized_index.js  # Монолитный файл (318 строк)
└── index.js           # Базовая версия
```

### Стало (v2.0.0):
```
server/src/
├── index.js                    # Точка входа (15 строк)
├── ServerManager.js            # Управление сервером
├── config/
│   └── ServerConfig.js         # Конфигурация
├── services/
│   ├── ClientManagerService.js # Клиенты
│   ├── VideoStatsService.js    # Статистика
│   └── WebSocketService.js     # WebSocket
├── handlers/
│   └── MessageHandler.js       # Сообщения
├── routes/
│   └── ApiRoutes.js            # API
└── tests/
    └── ServerManager.test.js   # Тесты
```

## Команды запуска

### Старые команды:
```bash
npm run start          # Запускал optimized_index.js
npm run start-basic    # Запускал index.js
```

### Новые команды:
```bash
npm start              # Запускает новую архитектуру
npm run dev            # Режим разработки
npm test               # Запуск тестов
npm run test:watch     # Тесты в watch режиме
```

## API изменения

### Новые эндпоинты:
- `/api/status` - основная информация
- `/api/status/detailed` - детальная статистика
- `/api/video/stats` - статистика видео
- `/api/video/control` - управление видео
- `/api/connections` - информация о подключениях
- `/api/health` - health check

### Обратная совместимость:
- `/status` → перенаправляется на `/api/status/detailed`
- WebSocket протокол остался без изменений

## Конфигурация

### Переменные окружения:
```bash
PORT=8080              # Порт сервера
NODE_ENV=production    # Окружение
LOG_LEVEL=info         # Уровень логирования
```

## Преимущества новой архитектуры

1. **Модульность** - код разделен на логические модули
2. **Тестируемость** - каждый модуль можно тестировать отдельно
3. **Расширяемость** - легко добавлять новые функции
4. **Поддерживаемость** - четкое разделение ответственности
5. **Конфигурируемость** - централизованная конфигурация

## Миграция

1. Обновите зависимости:
```bash
npm install
```

2. Для разработки добавьте Jest:
```bash
npm install --save-dev jest
```

3. Запустите новую версию:
```bash
npm start
```

4. Проверьте работу:
```bash
curl http://localhost:8080/api/health
```

## Что не изменилось

- WebSocket протокол общения с роботом и Unity
- Формат сообщений (COMMAND!, VIDEO_FRAME!, и т.д.)
- Порт по умолчанию (8080)
- Основная функциональность сервера

## Устранение проблем

### Сервер не запускается:
1. Проверьте версию Node.js (требуется >= 14)
2. Убедитесь что порт свободен
3. Проверьте переменные окружения

### WebSocket не подключается:
1. Убедитесь что клиенты используют правильный протокол регистрации
2. Проверьте логи сервера на ошибки
3. Используйте `/api/connections` для диагностики

### Видео не работает:
1. Проверьте `/api/video/stats` для диагностики
2. Убедитесь что робот подключен
3. Используйте `/api/video/control` для управления потоком 